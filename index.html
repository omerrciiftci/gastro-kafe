<!doctype html>
<html lang="tr" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gastro Kafe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class',theme:{extend:{colors:{brand:'var(--brand-color)'}}}}</script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --brand-color: #ea580c; }
    body { font-family: 'Outfit', sans-serif; transition: background-color 0.3s, color 0.3s; }
    .glass-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    .dark .glass-card { background: rgba(30,41,59,0.7); border: 1px solid rgba(255,255,255,0.05); }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .cat-btn.active { background: var(--brand-color); color: white; border:none; }
    #sidebar { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
    #sidebar.open { transform: translateX(0); }
    .credit-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 pb-32">

  <div class="sticky top-0 z-40 bg-white/80 dark:bg-gray-900/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 shadow-sm">
    <div class="p-4 flex justify-between items-center">
        <div>
            <h2 class="font-bold text-xl text-brand">Gastro Kafe</h2>
            <div class="text-xs text-gray-500 dark:text-gray-400" data-lang="welcome">HoÅŸgeldiniz</div>
        </div>
        <button onclick="toggleSidebar()" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-800">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </div>
    <div class="flex overflow-x-auto gap-3 p-4 pt-0 hide-scroll" id="category-nav"></div>
  </div>

  <div id="sidebar" class="fixed inset-y-0 right-0 w-72 bg-white dark:bg-gray-800 shadow-2xl z-[100] p-6">
    <div class="flex justify-between items-center mb-8">
        <h3 class="font-bold text-xl" data-lang="settings">Ayarlar</h3>
        <button onclick="toggleSidebar()" class="text-2xl">&times;</button>
    </div>
    
    <div class="space-y-6">
        <div>
            <h4 class="text-sm font-bold text-gray-500 mb-2">Language / Dil</h4>
            <div class="flex gap-2">
                <button onclick="changeLang('tr')" class="flex-1 py-2 rounded-lg border border-gray-300 dark:border-gray-600 font-bold">ğŸ‡¹ğŸ‡· TR</button>
                <button onclick="changeLang('en')" class="flex-1 py-2 rounded-lg border border-gray-300 dark:border-gray-600 font-bold">ğŸ‡¬ğŸ‡§ EN</button>
            </div>
        </div>

        <div>
            <h4 class="text-sm font-bold text-gray-500 mb-2" data-lang="theme">Tema</h4>
            <div class="flex gap-2 p-1 bg-gray-200 dark:bg-gray-700 rounded-xl">
                <button onclick="setTheme('light')" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white dark:bg-transparent shadow-sm dark:shadow-none">â˜€ï¸</button>
                <button onclick="setTheme('dark')" class="flex-1 py-2 rounded-lg text-sm font-bold dark:bg-gray-600">ğŸŒ™</button>
            </div>
        </div>
        
        <div>
            <h4 class="text-sm font-bold text-gray-500 mb-2" data-lang="color">Renk</h4>
            <div class="grid grid-cols-4 gap-2">
                <button onclick="setColor('#ea580c')" class="w-10 h-10 rounded-full bg-orange-600"></button>
                <button onclick="setColor('#2563eb')" class="w-10 h-10 rounded-full bg-blue-600"></button>
                <button onclick="setColor('#7c3aed')" class="w-10 h-10 rounded-full bg-purple-600"></button>
                <button onclick="setColor('#16a34a')" class="w-10 h-10 rounded-full bg-green-600"></button>
            </div>
        </div>
    </div>
  </div>

  <div class="container mx-auto px-4 mt-6" id="menu-container"></div>

  <div id="cart-bar" class="fixed bottom-4 left-4 right-4 glass-card p-4 rounded-2xl shadow-xl transform translate-y-[150%] transition-transform duration-300 z-50 flex justify-between items-center bg-white dark:bg-gray-800">
    <div class="flex flex-col">
        <span class="text-xs text-gray-500 dark:text-gray-400" data-lang="total">Toplam</span>
        <span class="text-2xl font-bold dark:text-white" id="total-price">0 â‚º</span>
    </div>
    <button onclick="openPaymentModal()" class="bg-[var(--brand-color)] text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg active:scale-95 transition">
        <span data-lang="confirm_cart">Sepeti Onayla</span>
        <span id="cart-badge" class="bg-white text-[var(--brand-color)] text-xs px-2 py-0.5 rounded-full font-extrabold hidden">0</span>
    </button>
  </div>

  <div id="payment-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-[slideUp_0.3s]">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold dark:text-white" data-lang="payment_title">Ã–deme Bilgileri</h2>
            <button onclick="closePaymentModal()" class="text-gray-400 text-2xl">&times;</button>
        </div>
        
        <div class="credit-card text-white p-6 rounded-2xl mb-6 shadow-lg relative overflow-hidden">
            <div class="absolute top-0 right-0 -m-4 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
            <div class="flex justify-between items-center mb-8">
                <span class="text-xs opacity-70">Credit Card</span>
                <span class="font-bold italic">VISA</span>
            </div>
            <div class="text-2xl font-mono mb-4 tracking-widest">**** **** **** 4289</div>
            <div class="flex justify-between">
                <div>
                    <div class="text-[10px] opacity-70">Card Holder</div>
                    <div class="text-sm font-bold">MÃœÅTERÄ° ADI</div>
                </div>
                <div>
                    <div class="text-[10px] opacity-70">Expires</div>
                    <div class="text-sm font-bold">12/28</div>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <input type="text" id="customer-name" class="w-full bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl p-4 outline-none border-2 border-transparent focus:border-[var(--brand-color)]" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z">
            <select id="table-no" class="w-full bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl p-4 outline-none">
                <option value="Masa 1">Masa 1</option>
                <option value="Masa 2">Masa 2</option>
                <option value="Masa 3">Masa 3</option>
                <option value="BahÃ§e 1">BahÃ§e 1</option>
            </select>
            <button onclick="processOrder()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                <span data-lang="pay_btn">Ã–deme Yap ve SipariÅŸ Ver</span> ğŸ”’
            </button>
        </div>
    </div>
  </div>

  <div id="preparing-view" class="fixed inset-0 bg-yellow-500 z-[70] hidden flex flex-col items-center justify-center p-8 text-center text-white">
    <div class="w-24 h-24 border-8 border-white border-t-transparent rounded-full animate-spin mb-6"></div>
    <h2 class="text-3xl font-bold mb-2" data-lang="prep_title">HazÄ±rlanÄ±yor...</h2>
    <p class="text-yellow-100 text-lg" data-lang="prep_desc">Usta iÅŸ baÅŸÄ±nda! HazÄ±r olunca sana haber vereceÄŸim.</p>
  </div>

  <div id="ready-view" class="fixed inset-0 bg-green-600 z-[80] hidden flex flex-col items-center justify-center p-8 text-center text-white">
    <div class="text-6xl mb-6 animate-bounce">ğŸ””</div>
    <h2 class="text-4xl font-bold mb-4" data-lang="ready_title">SÄ°PARÄ°Å HAZIR!</h2>
    <p class="text-green-100 text-lg mb-8" id="ready-msg" data-lang="ready_desc">LÃ¼tfen mutfak bankosundan teslim al.</p>
    
    <button id="btn-received" onclick="confirmReceived()" class="bg-white text-green-700 px-10 py-5 rounded-2xl font-bold text-xl shadow-2xl hover:scale-105 transition">
        <span data-lang="btn_received">âœ… Teslim AldÄ±m</span>
    </button>
    
    <div id="waiting-waiter-msg" class="hidden mt-4 bg-green-800/50 p-4 rounded-xl animate-pulse">
        <span data-lang="wait_waiter">â³ Garson onayÄ± bekleniyor...</span>
    </div>
  </div>

  <script>
    // --- Ã‡OKLU DÄ°L SÄ°STEMÄ° ---
    const translations = {
        tr: {
            welcome: "HoÅŸgeldiniz", settings: "Ayarlar", theme: "Tema", color: "Renk", total: "Toplam",
            confirm_cart: "Sepeti Onayla", payment_title: "Ã–deme Bilgileri", pay_btn: "Ã–deme Yap ve SipariÅŸ Ver",
            prep_title: "HazÄ±rlanÄ±yor...", prep_desc: "Usta iÅŸ baÅŸÄ±nda! HazÄ±r olunca bildirim gelecek.",
            ready_title: "SÄ°PARÄ°Å HAZIR!", ready_desc: "LÃ¼tfen mutfak bankosundan teslim al.",
            btn_received: "âœ… Teslim AldÄ±m", wait_waiter: "â³ Garson onayÄ± bekleniyor..."
        },
        en: {
            welcome: "Welcome", settings: "Settings", theme: "Theme", color: "Color", total: "Total",
            confirm_cart: "Confirm Order", payment_title: "Payment Details", pay_btn: "Pay & Order",
            prep_title: "Preparing...", prep_desc: "Chef is cooking! We will notify you.",
            ready_title: "ORDER READY!", ready_desc: "Please pick up from the counter.",
            btn_received: "âœ… Received", wait_waiter: "â³ Waiting for Waiter..."
        }
    };
    let currentLang = 'tr';

    function changeLang(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-lang]').forEach(el => {
            const key = el.getAttribute('data-lang');
            if(translations[lang][key]) el.innerText = translations[lang][key];
        });
        // Kategorileri gÃ¼ncelle (Basit Ã§Ã¶zÃ¼m: reload yerine text deÄŸiÅŸimi)
        init(); 
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function setTheme(mode) { 
        if(mode==='dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); 
        localStorage.setItem('theme', mode);
    }
    function setColor(color) { 
        document.documentElement.style.setProperty('--brand-color', color); 
        localStorage.setItem('brandColor', color);
    }
    if(localStorage.getItem('theme')==='dark') setTheme('dark');
    if(localStorage.getItem('brandColor')) setColor(localStorage.getItem('brandColor'));

    function requestNotificationPermission() { if ("Notification" in window) Notification.requestPermission(); }

    const categories = [
        {id:'sicak', name_tr:'SÄ±caklar', name_en:'Hot Drinks'},
        {id:'soguk', name_tr:'SoÄŸuklar', name_en:'Cold Drinks'},
        {id:'tatli', name_tr:'TatlÄ±lar', name_en:'Desserts'},
        {id:'yemek', name_tr:'Yemek', name_en:'Food'}
    ];
    const menuItems = [
        {id:1,cat:'sicak',name:'Ã‡ay',price:25,img:'â˜•'}, {id:2,cat:'sicak',name:'Latte',price:65,img:'ğŸ¥›'},
        {id:3,cat:'soguk',name:'Limonata',price:55,img:'ğŸ‹'}, {id:4,cat:'tatli',name:'Cheesecake',price:120,img:'ğŸ°'},
        {id:5,cat:'yemek',name:'Hamburger',price:150,img:'ğŸ”'}, {id:6,cat:'yemek',name:'Tost',price:80,img:'ğŸ¥ª'}
    ];

    let cart = [];
    let activeOrderId = null;

    function init() {
        requestNotificationPermission();
        const navHtml = categories.map((c,i) => {
            const name = currentLang === 'tr' ? c.name_tr : c.name_en;
            return `<button onclick="scrollCat('${c.id}',this)" class="cat-btn ${i===0?'active':''} px-5 py-2 rounded-full border border-gray-300 dark:border-gray-700 font-bold whitespace-nowrap transition text-sm">${name}</button>`
        }).join('');
        document.getElementById('category-nav').innerHTML = navHtml;

        const containerHtml = categories.map(cat => {
            const items = menuItems.filter(i=>i.cat===cat.id);
            if(!items.length) return '';
            const catName = currentLang === 'tr' ? cat.name_tr : cat.name_en;
            return `<div id="${cat.id}" class="mb-8 scroll-mt-24"><h3 class="font-bold text-xl mb-4 text-[var(--brand-color)]">${catName}</h3><div class="grid gap-3">${items.map(i=>`
                <div class="glass-card p-3 rounded-xl flex justify-between items-center shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl bg-gray-100 dark:bg-gray-800 w-12 h-12 flex items-center justify-center rounded-lg">${i.img}</div>
                        <div><div class="font-bold dark:text-white">${i.name}</div><div class="text-[var(--brand-color)] font-bold">${i.price} â‚º</div></div>
                    </div>
                    <button onclick="add(${i.id})" class="bg-gray-200 dark:bg-gray-700 w-10 h-10 rounded-full font-bold text-xl text-[var(--brand-color)]">+</button>
                </div>`).join('')}</div></div>`;
        }).join('');
        document.getElementById('menu-container').innerHTML = containerHtml;
    }

    window.scrollCat=(id,b)=>{document.getElementById(id).scrollIntoView({behavior:'smooth'});document.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active')};
    window.add=(id)=>{cart.push(menuItems.find(i=>i.id===id));updateCart()};
    function updateCart(){
        const b=document.getElementById('cart-bar');
        if(cart.length>0){
            b.classList.remove('translate-y-[150%]');
            document.getElementById('total-price').innerText=cart.reduce((a,b)=>a+b.price,0)+' â‚º';
            document.getElementById('cart-badge').innerText=cart.length;
            document.getElementById('cart-badge').classList.remove('hidden');
        }
    }

    window.openPaymentModal=()=>document.getElementById('payment-modal').classList.remove('hidden');
    window.closePaymentModal=()=>document.getElementById('payment-modal').classList.add('hidden');

    window.processOrder = async () => {
        const name = document.getElementById('customer-name').value;
        const table = document.getElementById('table-no').value;
        if(!name) { alert(currentLang==='tr'?"Ä°sim giriniz!":"Enter name!"); return; }

        try {
            const res = await fetch('/api/orders', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({customer_name: name, table_number: table, items: cart.map(i=>i.name).join(', '), total_price: cart.reduce((a,b)=>a+b.price,0)})
            });
            const data = await res.json();
            if(data.status === 'success') {
                closePaymentModal();
                activeOrderId = data.order_id;
                cart = [];
                document.getElementById('cart-bar').classList.add('translate-y-[150%]');
                document.getElementById('preparing-view').classList.remove('hidden');
                startStatusCheck();
            }
        } catch(e) { alert("Error"); }
    };

    function startStatusCheck() {
        const check = setInterval(async () => {
            if(!activeOrderId) { clearInterval(check); return; }
            try {
                const res = await fetch(`/api/orders/${activeOrderId}`);
                const order = await res.json();
                
                // SipariÅŸ Tamamen Bitti mi?
                if(order.status === 'completed') {
                    document.getElementById('ready-view').classList.add('hidden');
                    alert(currentLang==='tr' ? "Afiyet olsun! Ä°ÅŸlem tamam." : "Enjoy! Order completed.");
                    location.reload();
                }
                // SipariÅŸ HazÄ±r Ama Onay Bekliyor mu?
                else if(order.status === 'ready') {
                    document.getElementById('preparing-view').classList.add('hidden');
                    document.getElementById('ready-view').classList.remove('hidden');
                    
                    // EÄŸer mÃ¼ÅŸteri zaten onayladÄ±ysa ama garson onaylamadÄ±ysa:
                    if(order.customer_ok) {
                        document.getElementById('btn-received').classList.add('hidden');
                        document.getElementById('waiting-waiter-msg').classList.remove('hidden');
                    } else {
                        // HenÃ¼z mÃ¼ÅŸteri onaylamadÄ±
                        if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    }
                }
            } catch(e) {}
        }, 3000);
    }

    window.confirmReceived = async () => {
        if(!activeOrderId) return;
        try {
            // MÃ¼ÅŸteri "AldÄ±m" dedi
            await fetch(`/api/orders/${activeOrderId}/confirm`, {
                method: 'PUT', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({role: 'customer'})
            });
            // Ekranda deÄŸiÅŸikliÄŸi gÃ¶stermek iÃ§in status check dÃ¶ngÃ¼sÃ¼nÃ¼ beklemiyoruz, hemen UI gÃ¼ncelliyoruz
            document.getElementById('btn-received').classList.add('hidden');
            document.getElementById('waiting-waiter-msg').classList.remove('hidden');
        } catch(e) { alert("Error"); }
    };

    init();
  </script>
</body>
</html>
