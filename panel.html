<!doctype html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Gastro Mutfak Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body{background-color:#111827; color:white;}</style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-orange-500">ğŸ”¥ CANLI MUTFAK</h1>
            <div class="text-sm text-gray-400" id="clock">00:00</div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">
            
            <div class="bg-gray-800 rounded-2xl p-4 border border-yellow-600/30">
                <h2 class="text-xl font-bold mb-4 text-yellow-400">ğŸ•’ HAZIRLANIYOR</h2>
                <div id="col-preparing" class="space-y-3 min-h-[300px]"></div>
            </div>

            <div class="bg-gray-800 rounded-2xl p-4 border border-green-600/30">
                <h2 class="text-xl font-bold mb-4 text-green-400">ğŸ”” SERVÄ°S BEKLÄ°YOR</h2>
                <div id="col-ready" class="space-y-3 min-h-[300px]"></div>
            </div>

            <div class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-gray-500">ğŸ SON TESLÄ°MLER</h2>
                <div id="col-completed" class="space-y-3 opacity-60"></div>
            </div>
        </div>

        <div class="bg-gray-900 border border-gray-700 rounded-3xl p-8 mt-12">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                ğŸ“… GeÃ§miÅŸ SipariÅŸ ArÅŸivi
            </h2>
            
            <div class="flex gap-4 mb-6">
                <input type="date" id="history-date" class="bg-gray-800 text-white border border-gray-600 rounded-xl px-4 py-3 outline-none focus:border-orange-500">
                <button onclick="loadHistory()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-xl font-bold transition">
                    Getir
                </button>
            </div>

            <div id="history-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-gray-300">
                <div class="col-span-full text-gray-500 italic">Tarih seÃ§ip 'Getir' butonuna basÄ±nÄ±z...</div>
            </div>
        </div>

    </div>

    <script>
        // SAAT GÃœNCELLEME
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString();
        }, 1000);

        // CANLI SÄ°PARÄ°ÅLERÄ° YÃ–NET
        async function updateStatus(id, status) {
            try {
                await fetch(`/api/orders/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status: status})
                });
                loadOrders();
            } catch(e) { alert("Hata"); }
        }

        async function loadOrders() {
            try {
                const res = await fetch('/api/orders'); // Sadece aktifler gelir
                const orders = await res.json();
                
                const preparingHTML = [];
                const readyHTML = [];
                const completedHTML = [];

                orders.forEach(o => {
                    const card = `
                        <div class="bg-gray-700 p-4 rounded-xl shadow-lg border-l-4 ${o.status==='preparing'?'border-yellow-500':(o.status==='ready'?'border-green-500':'border-gray-500')} animate-[fadeIn_0.5s]">
                            <div class="flex justify-between mb-2">
                                <span class="font-bold bg-white text-black px-2 rounded">${o.table_number}</span>
                                <span class="text-xs text-gray-400">#${o.id}</span>
                            </div>
                            <div class="text-lg font-bold text-white mb-1">${o.customer_name}</div>
                            <div class="text-sm text-gray-300 mb-2 bg-black/20 p-2 rounded">${o.items}</div>
                            <div class="text-right font-bold text-orange-400">${o.total_price} â‚º</div>
                            
                            ${o.status === 'preparing' ? 
                                `<button onclick="updateStatus(${o.id}, 'ready')" class="w-full mt-3 bg-green-600 text-white font-bold py-2 rounded hover:bg-green-500">HAZIRLA âœ…</button>` : ''}
                            ${o.status === 'ready' ? 
                                `<button onclick="updateStatus(${o.id}, 'completed')" class="w-full mt-3 bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-500">TESLÄ°M ET ğŸ</button>` : ''}
                        </div>`;

                    if(o.status === 'preparing') preparingHTML.push(card);
                    else if(o.status === 'ready') readyHTML.push(card);
                    else if(o.status === 'completed') completedHTML.push(card);
                });

                document.getElementById('col-preparing').innerHTML = preparingHTML.join('');
                document.getElementById('col-ready').innerHTML = readyHTML.join('');
                document.getElementById('col-completed').innerHTML = completedHTML.join('');
            } catch(e) {}
        }

        // GEÃ‡MÄ°Å SÄ°PARÄ°ÅLERÄ° GETÄ°R
        async function loadHistory() {
            const dateVal = document.getElementById('history-date').value;
            if(!dateVal) { alert("LÃ¼tfen tarih seÃ§in"); return; }
            
            try {
                const res = await fetch(`/api/orders/history?date_str=${dateVal}`);
                const orders = await res.json();
                
                const container = document.getElementById('history-results');
                if(orders.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center p-4 bg-gray-800 rounded">âŒ Bu tarihte kayÄ±tlÄ± sipariÅŸ yok.</div>`;
                    return;
                }

                let totalDaily = 0;
                let html = orders.map(o => {
                    totalDaily += o.total_price;
                    return `
                    <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>${o.created_at.split('T')[1].substring(0,5)}</span>
                            <span>#${o.id}</span>
                        </div>
                        <div class="font-bold text-orange-400">${o.customer_name}</div>
                        <div class="text-xs text-gray-400 truncate">${o.items}</div>
                        <div class="text-right font-bold mt-1">${o.total_price} â‚º</div>
                    </div>`;
                }).join('');

                // Toplam Ciroyu baÅŸa ekle
                html = `<div class="col-span-full bg-green-900/30 border border-green-600 p-4 rounded-xl flex justify-between items-center mb-4">
                            <span class="font-bold text-green-400 text-xl">ğŸ’° GÃœNLÃœK TOPLAM CÄ°RO:</span>
                            <span class="font-bold text-white text-2xl">${totalDaily} â‚º</span>
                        </div>` + html;

                container.innerHTML = html;

            } catch(e) { alert("Veri Ã§ekilemedi"); }
        }

        setInterval(loadOrders, 4000);
        loadOrders();
    </script>
</body>
</html>
