<!doctype html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="Ã–mer Faruk Ã‡iftci">
    <title>Mutfak Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body{background-color:#111827; color:white;}</style>
</head>
<body class="p-4 relative">
    
    <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
        <div>
            <h1 class="text-3xl font-bold text-orange-500">ğŸ”¥ MUTFAK</h1>
            <div class="text-sm text-gray-400" id="clock">00:00</div>
        </div>
        <button onclick="toggleHistory()" class="bg-gray-800 p-3 rounded-xl border border-gray-600 hover:bg-gray-700">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </div>

    <div id="main-view" class="grid grid-cols-1 lg:grid-cols-3 gap-4 pb-12">
        <div class="bg-gray-800/50 rounded-2xl p-3 border border-yellow-600/30">
            <h2 class="font-bold text-yellow-400 mb-2 text-center text-lg">ğŸ‘¨â€ğŸ³ HAZIRLANIYOR</h2>
            <div id="col-preparing" class="space-y-2"></div>
        </div>

        <div class="bg-gray-800/50 rounded-2xl p-3 border border-green-600/30">
            <h2 class="font-bold text-green-400 mb-2 text-center text-lg">ğŸ”” SERVÄ°S / ONAY</h2>
            <div id="col-ready" class="space-y-2"></div>
        </div>

        <div class="bg-gray-800/30 rounded-2xl p-3 border border-gray-700">
            <h2 class="font-bold text-gray-500 mb-2 text-center text-lg">ğŸ BÄ°TENLER</h2>
            <div id="col-completed" class="space-y-2 opacity-60"></div>
        </div>
    </div>

    <div id="history-view" class="fixed inset-0 bg-gray-900 z-50 hidden p-6 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold">ğŸ“… GeÃ§miÅŸ ArÅŸivi</h2>
                <button onclick="toggleHistory()" class="text-4xl text-gray-400">&times;</button>
            </div>
            <div class="flex gap-4 mb-6">
                <input type="date" id="history-date" class="bg-gray-800 text-white border border-gray-600 rounded-xl px-4 py-3">
                <button onclick="loadHistory()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold">Sorgula</button>
            </div>
            <div id="history-results" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <div class="fixed bottom-2 right-4 text-gray-600 text-xs opacity-60 hover:opacity-100 transition cursor-default select-none">
        âš¡ Dev by <strong class="text-orange-500">Ã–mer Ã‡iftÃ§i</strong>
    </div>

    <script>
        setInterval(()=>document.getElementById('clock').innerText=new Date().toLocaleTimeString(),1000);
        function toggleHistory(){ document.getElementById('history-view').classList.toggle('hidden'); }

        async function setStatus(id, status) {
            await fetch(`/api/orders/${id}/status`, {
                method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({status:status})
            });
            loadOrders();
        }

        async function confirmDelivery(id) {
            await fetch(`/api/orders/${id}/confirm`, {
                method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({role:'waiter'})
            });
            loadOrders();
        }

        async function loadOrders() {
            try {
                const res = await fetch('/api/orders');
                const orders = await res.json();
                
                const prep = [], ready = [], comp = [];

                orders.forEach(o => {
                    let btnHtml = '';
                    
                    if(o.status === 'preparing') {
                        btnHtml = `<button onclick="setStatus(${o.id}, 'ready')" class="w-full bg-yellow-600 text-white font-bold py-2 rounded text-sm hover:bg-yellow-500">HAZIRLA ğŸ³</button>`;
                    }
                    else if(o.status === 'ready') {
                        if(o.waiter_ok && !o.customer_ok) {
                            btnHtml = `<div class="bg-orange-900/50 text-orange-200 text-center py-2 rounded text-xs border border-orange-500 animate-pulse">â³ MÃœÅTERÄ° ONAYI BEKLENÄ°YOR</div>`;
                        } else if(!o.waiter_ok && o.customer_ok) {
                            btnHtml = `<button onclick="confirmDelivery(${o.id})" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded text-sm animate-pulse">MÃœÅTERÄ° BEKLÄ°YOR: TESLÄ°M ET âœ…</button>`;
                        } else {
                            btnHtml = `<button onclick="confirmDelivery(${o.id})" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded text-sm">TESLÄ°M ETTÄ°M (ONAYLA) ğŸ“¤</button>`;
                        }
                    }

                    let card = `
                        <div class="bg-gray-700 p-3 rounded-lg shadow border-l-4 ${o.status==='preparing'?'border-yellow-500':(o.status==='ready'?'border-green-500':'border-gray-500')}">
                            <div class="flex justify-between mb-1"><span class="font-bold bg-white text-black px-1 rounded text-sm">${o.table_number}</span><span class="text-xs text-gray-400">#${o.id}</span></div>
                            <div class="font-bold text-lg">${o.customer_name}</div>
                            <div class="text-sm text-gray-300 mb-2 truncate">${o.items}</div>
                            ${btnHtml}
                        </div>`;

                    if(o.status === 'preparing') prep.push(card);
                    else if(o.status === 'ready') ready.push(card); 
                    else if(o.status === 'completed') comp.push(card);
                });

                document.getElementById('col-preparing').innerHTML = prep.join('');
                document.getElementById('col-ready').innerHTML = ready.join('');
                document.getElementById('col-completed').innerHTML = comp.join('');
            } catch(e) {}
        }

        async function loadHistory() {
            const d = document.getElementById('history-date').value;
            if(!d) return alert("Tarih seÃ§in");
            const res = await fetch(`/api/orders/history?date_str=${d}`);
            const data = await res.json();
            const total = data.reduce((a,b)=>a+b.total_price,0);
            
            let html = `<div class="col-span-full bg-blue-900 p-4 rounded text-center font-bold text-xl">TOPLAM CÄ°RO: ${total} â‚º</div>`;
            html += data.map(o=>`<div class="bg-gray-800 p-3 rounded border border-gray-600"><div>#${o.id} - ${o.customer_name}</div><div class="text-xs text-gray-400">${o.items}</div><div class="text-right font-bold">${o.total_price} â‚º</div></div>`).join('');
            document.getElementById('history-results').innerHTML = html;
        }

        setInterval(loadOrders, 2000);
        loadOrders();
    </script>
</body>
</html>

